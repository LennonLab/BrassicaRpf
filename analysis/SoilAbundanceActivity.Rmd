---
title: "SoilAbundanceActivity"
author: "Venus"
date: "July 03, 2017"
output: html_document
---
# 1) Questions

- How does Rpf alter the soil microbial community abundance and activity? 

# 2) Setting up work environment 

```{r, message=FALSE, warning=FALSE}
# Set working directory #
rm(list = ls())
getwd()
setwd("~/../Github/BrassicaRpf/data")

# Require or install packages #
package.list <- c('plyr', 'grid' ,'png', 'car', 'bbmle', 'ggplot2', 'vegan', 'tidyr', 'dplyr', 'codyn', 'cowplot', 'MullerPlot', 'RColorBrewer', 'pander', 'reshape', 'nlme') 
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
  } }

# Load small function # 
sem <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}

fancy_scientific <- function(l) {
     # turn in to character string in scientific notation
     l <- format(l, scientific = TRUE)
     # quote the part before the exponent to keep all the digits
     l <- gsub("^(.*)e", "'\\1'e", l)
     # turn the 'e+' into plotmath format
     l <- gsub("e", "%*%10^", l)
     # return this as an expression
     parse(text=l)
}
```

# 3) Load data and calculate corrected copy number 

qPCR.csv : Quantitative PCR results of bacterial (EUB 338f-515r) and fungal (5.8f-ITs4r) gene copy abundances in live soil DNA taken from experimental pots containing Brassica plants. CSV file contains Treatment, Rep, Week, Well position, and Gene copy amount.

GCH_CO2.csv : CO2 respiration measurement of growth chamber soil samples for all six weeks. Contains sample ID, treatment (rpf+ = 1, rpf-= 2), soil (simple = 1, complex = 2), plant (present = 1, not present = 2), hour, week 1-6.

```{r , message=FALSE, warning=FALSE}
# Set working directory # 
setwd("~/../Github/BrassicaRpf/data")

# Read csv files # 
abundance <- read.csv("qPCR.txt", header=T) 
# Log transformed and standardized based on soil gram and extracted DNA concentration # 

CO2 <- read.csv("GCH_CO2.csv", header=T)

# Define factor levels for bacterial and fungal qPCR data # 
abundance$Week<- factor(abundance$Week)
abundance <- na.omit(abundance)

soil <- abundance$Soil
dna <- abundance$DNA
abundance$stdGeneCopy <- (abundance$GeneCopy)/soil#/dna
abundance$log10stdGeneCopy <- log10(abundance$stdGeneCopy)

# Define factor levels for microbial soil respiration data # 
```

# 4) Visualization of microbial abundance in soil

qPCR gene copy abundances as a metric for bacterial (16s rRNA). 
Two-factor ANOVA testing the effect of Rpf treatment and week number (1 or 6) on bacterial soil abundance.
qPCR gene copy abundances as a metric for fungal (ITS) abundance 
Two-factor ANOVA testing the effect of Rpf treatment and week number (1 or 6) on fungal soil abundance.

## Bacterial gene copy abundance standardized by soil amount and DNA extracted

```{r}
# Subset bacterial 16S dataset # 
bac.abundance <- subset(abundance, Gene=="16S rRNA" , select=c(Treatment, Week, stdGeneCopy))

# Bacterial abundance: 16S rRNA gene copy abundance # 
bac.means <- ddply(bac.abundance, c("Treatment", "Week"), summarise, mean=mean(stdGeneCopy))

# Barplot of bacterial gene abundance in soil # 
bac.means.barplot <- ggplot(bac.means, aes(x=Week,y = mean, fill=Treatment)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1) 

# Calculate bacterial gene abundance standard errors of the means # 
bac.means.sem <- ddply(bac.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(stdGeneCopy), sem=sd(stdGeneCopy)/sqrt(length(stdGeneCopy)))
bac.means.sem <- transform(bac.means.sem, lower=mean-sem, upper=mean+sem)

# Barplot of bacterial gene abundance in soil for pub figures # 
bac.means.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=bac.means.sem, width = 0.2, size=1) +
  labs(x="Time (week)", y="16S rRNA gene copy/Soil (g)") +
  theme_classic() +
  scale_fill_manual(values=c("Grey", "White")) +
  theme(axis.text.y=element_text(colour="black", size=16),
        axis.text.x=element_text(colour="black", size =16),
        axis.title=element_text(size=20),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(15,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18))+
  scale_y_continuous(labels=fancy_scientific)  #+
#  annotate("text", x = 0.55, y = 1750000, label = c("a"), size=12) 

```

```{r}
# Bacterial abundance of just week 6 

# Subset bacterial 16S dataset # 
bac.abundance.6 <- subset(abundance, Gene=="16S rRNA" & Week == "6", select=c(Treatment,  stdGeneCopy))

# Bacterial abundance: 16S rRNA gene copy abundance # 
bac.means <- ddply(bac.abundance.6, c("Treatment"), summarise, mean=mean(stdGeneCopy))

# Barplot of bacterial gene abundance in soil # 
bac.means.barplot <- ggplot(bac.means, aes(x=Treatment,y = mean)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1 , fill=c("grey", "white")) 

# Calculate bacterial gene abundance standard errors of the means # 
bac.means.sem <- ddply(bac.abundance.6, c("Treatment"), summarise,
                   mean=mean(stdGeneCopy), sem=sd(stdGeneCopy)/sqrt(length(stdGeneCopy)))
bac.means.sem <- transform(bac.means.sem, lower=mean-sem, upper=mean+sem)

# Barplot of bacterial gene abundance in soil for pub figures # 
bac.means.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=bac.means.sem, width = 0.2, size=1) +
  labs( y="16S rRNA gene copy/Soil (g)") +
  theme_classic() +
  theme(axis.title.x=element_blank(),
        axis.text.y=element_text(colour="black", size=20),
        axis.text.x=element_text(colour="black", size =22),
        axis.title=element_text(size=20),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2)) +
  scale_y_continuous(labels=fancy_scientific)  #+



```




## Fungal ITS gene copy abundance standardized by soil amount and DNA extracted

```{r}
# Fungal ITS # 
# Subset ITS gene copy data # 
ITS.abundance <- subset(abundance, Gene=="ITS" , select=c(Treatment, Week, stdGeneCopy))

# Fungal abundance: ITS gene copy abundance # 
ITS.means <- ddply(ITS.abundance, c("Treatment", "Week"), summarise, mean=mean(stdGeneCopy))

# Barplot of Fungal ITS abundance in soil # 
ITS.mean.barplot<- ggplot(ITS.means, aes(x=Week,y = mean, fill=Treatment)) +
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1) 

# Calculate fungal ITS gene abundance standard errors of the means # 
ITS.means.sem <- ddply(ITS.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(stdGeneCopy), sem=sd(stdGeneCopy)/sqrt(length(stdGeneCopy)))

ITS.means.sem <- transform(ITS.means.sem, lower=mean-sem, upper=mean+sem)

# Barplot of fungal gene abundance in soil for pub figures # 
ITS.mean.barplot + 
  geom_errorbar(aes(ymax=upper, ymin=lower), position=position_dodge(0.65), 
                data=ITS.means.sem, width = 0.2, size=1) +
  labs(x="Time (week)", y="ITS gene copy/Soil (g)") +
  theme_classic() +
  scale_fill_manual(values=c("Grey", "White")) +
  theme(axis.text.y=element_text(colour="black", size=16),
        axis.text.x=element_text(colour="black", size =16),
        axis.title=element_text(size=20),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(15,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  scale_y_continuous(labels=fancy_scientific)#+
#  annotate("text", x =0.55, y=2500000, label = c("b"), size=12)
```

# 5) Does Rpf treatment affect Bacterial and fungal gene copy abundances?

```{r}
# Bacterial 16S rRNA # 
# Two Factor ANOVA of 16S rRNA bacterial gene copy abundances affected by Treatment and week of growth chamber experiment # 
bac.aov <- aov(stdGeneCopy ~ Treatment, data=bac.abundance.6)
summary(bac.aov)
TukeyHSD(bac.aov)

# Results: Rpf application to potted soil significantly (p<0.005) reduces bacterial 16S rRNA gene copy numbers # 
# Gene copy number increases significantly over the 6 week growth chamber experiment # 
bac.aov <- aov(stdGeneCopy ~ Treatment*Week, data=bac.abundance)
summary(bac.aov)
TukeyHSD(bac.aov)


```



```{r}
# Fungal ITS # 
# Two Factor ANOVA of ITS Fungal gene copy abundances affected by Treatment and week of growth chamber experiment # 
ITS.aov <- anova(lm(stdGeneCopy ~ Treatment, data=ITS.abundance))
ITS.aov
# Results: Rpf application to potted soil significantly (p<0.005) reduces bacterial 16S rRNA gene copy numbers # 
# Gene copy number increases significantly over the 6 week growth chamber experiment # 
ITS.aov <- aov(stdGeneCopy ~ Treatment*Week, data=ITS.abundance)
summary(ITS.aov)
TukeyHSD(ITS.aov)


# Repeated measures ANOVA --> May not be appropiate because I only have 2 time points and 2 treatment groups. 
CO2.m <- melt(bac.abundance)
CO2.m$variable <- as.factor(CO2.m$variable)

CO2.rm <- lme(value ~ Week*Treatment, random = ~ 1 | variable,
              correlation = corAR1(form = ~1 | variable), 
              data = CO2.m)

rich.cmp <- lme(value ~ Week*Treatment, random = ~ 1 | variable,
                correlation = corCompSymm(form = ~1 | variable),
                data = CO2.m)
set.caption("RMANOVA for soil CO2 respiration")
pander(anova(rich.cmp))



CO2.m <- melt(ITS.abundance)
CO2.m$variable <- as.factor(CO2.m$variable)

CO2.rm <- lme(value ~ Week*Treatment, random = ~ 1 | variable,
              correlation = corAR1(form = ~1 | variable), 
              data = CO2.m)

rich.cmp <- lme(value ~ Week*Treatment, random = ~ 1 | variable,
                correlation = corCompSymm(form = ~1 | variable),
                data = CO2.m)
set.caption("RMANOVA for soil CO2 respiration")
pander(anova(rich.cmp))

```

# 6) Visualization of microbial activity in soil 

24 and 48 hour soil CO2 respiration taken each week over the course of growth chamber experiment. 

```{r}
# Subsetting relevant data from CO2 dataset # 
CO2.sub <- subset(CO2, plant=="present" & hour =="24" & soil=="live", select=c(Treatment, soil, Week.1, Week.2, Week.3, Week.4, Week.5, Week.6))

# Change column names # 
colnames(CO2.sub) <- c("Treatment", "soil", "1","2","3","4","5","6")

# Melt data into three columns of treatment, soil and weeks # 
CO2.m <- melt(CO2.sub)
CO2.m$variable <- as.factor(CO2.m$variable)

# Standardizing the y-axis units by 24 hours # 
CO2.values <- CO2.m$value
CO2.m$StdCO2 <- CO2.values/24

# Summarizing data # 
CO2.means <- ddply(CO2.m, c("Treatment", "variable"), summarise, mean=mean(StdCO2))

# Calculating standard error of the means # 
CO2.means.sem <- ddply(CO2.m, c("Treatment", "variable"), summarise,
                   mean=mean(StdCO2), sem=sd(StdCO2)/sqrt(length(StdCO2)))

CO2.means.sem <- transform(CO2.means.sem, lower=mean-sem, upper=mean+sem)

# Plot line graph of summarized data # 
resp.line <- ggplot(CO2.means, aes(x=variable, y=mean, color=Treatment, linetype=)) + 
    geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.075) +
    geom_line() +
    geom_point()

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0) # move them .05 to the left and right

# Plot line graph # 
ggplot(CO2.means, aes(x=variable, y=mean, colour=Treatment, group=Treatment)) + 
  geom_errorbar(aes(ymax=upper, ymin=lower), position=position_dodge(0), 
                data=CO2.means.sem, width = 0.2, size=1) +
    geom_line(position=pd, size=2) +
    geom_point(position=pd, size=6, shape=21, fill="white") + # 21 is filled circle
    xlab("Time (weeks)") +
    ylab(expression(Soil~respiration~(ppm~CO[2]~d^-1))) +
   #scale_colour_hue(name="Treatment",    # Legend label, use darker colors
                     #breaks=c("Rpf-", "Rpf+"),
                    # labels=c("Rpf-", "Rpf+"),
                    # l=40) +   # Use darker colors, lightness=40
    theme_classic() +
    theme(legend.justification=c(1,0),
          legend.position=c(0.95,0.15),               # Position legend in bottom right
          axis.text.y=element_text(colour="black", size=20),
          axis.text.x=element_text(colour="black", size =20),
          axis.title=element_text(size=20),
          axis.title.y = element_text(colour="black",  margin = margin(0,10,0,0)),
          axis.title.x = element_text(colour="black",margin=margin(10,0,0,0)),
          panel.border = element_rect(linetype = "solid", colour = "black", size=2, fill=NA)) +
  scale_color_manual(values=c('#4daf4a','#377eb8'))

```

# 6) Time series analysis of CO2 respiration across growth chamber experiment 

Perform RM-ANOVA on CO2 respiration dataset. 

```{r}
# Perform RM-ANOVA #   
CO2.rm <- lme(value ~ variable*Treatment, random = ~ 1 | soil,
              correlation = corAR1(form = ~1 | soil), 
              data = CO2.m)

rich.cmp <- lme(value ~ variable*Treatment, random = ~ 1 | soil,
                correlation = corCompSymm(form = ~1 | soil),
                data = CO2.m)

# Next steps: Fix up CO2.m table so that week numbers are factors # 

# Look at detailed output #
#summary(rich.cmp)
#summary(CO2.rm)

# Make cleaner ANOVA table #
set.caption("RMANOVA for soil CO2 respiration")
pander(anova(rich.cmp))

# Make cleaner ANOVA table #
set.caption("RMANOVA for soil CO2 respiration")
pander(anova(CO2.rm))

# Multiple comparision tests # 
Rpf.CO2.aov <- aov(value ~ variable*Treatment, data=CO2.m)
summary(Rpf.CO2.aov)
TukeyHSD(Rpf.CO2.aov)

pairwise.t.test(Rpf.CO2.aov, ses, p.adj = "none")


require(multcomp)
summary(glht(rich.cmp, linfct=mcp(Treatment = "Tukey")), test = adjusted(type = "bonferroni"))
```

