---
title: "Figure 3 Community structure"
author: "Venus"
date: "June 10, 2017"
output: html_document
---

## 1) Soil community alpha diversity 

Question: How does Rpf treatment affect soil richness, eveness, and diversity? 

## 2) Set up work environment

```{r}
# Setup work enviroment 
rm(list = ls())
setwd("C:/Users/Venus/GitHub/BrassicaRpf/analysis")
source("C:/Users/Venus/GitHub/BrassicaRpf/analysis/MothurTools.R")
require("vegan")
require("gplots")
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
```

## 3) Describe and load data set

Brassica.design.txt : 
Brassica.bac.final.shared: A sample by species matrix of bacterial OTUs from Illumina MiSeq sequencing run. 
Brassica.taxon : 

```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
#design <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/output/Brassica.design.txt"
shared <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/output/Brassica.bac.final.shared"
#taxon <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/Brassica.bac.final.0.03.taxonomy"

```

## 4) Read otu using mothur tool code

```{r}
# Import Design
#design <- read.delim(design, header=T, row.names=1)

# Import Shared Files
OTUs <- read.otu(shared = shared, cutoff = "0.16")         # 86% Similarity

# Import Taxonomy
#OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Remove OTUs with less than two occurances across all sites
OTUs <- OTUs[, which(colSums(OTUs) >= 2)]
```

## 5) Determine coverage of OTU sampling and make relative abundance matrix

```{r}
# Coverage Stats
coverage <- rowSums(OTUs)
summary(coverage)

# Make Presence Absence Matrices
OTUsPA <- (OTUs > 0) * 1

rich <- rowSums(OTUsPA)
summary(rich)

# Make Relative Abundence Matrices
OTUsREL <- OTUs
for(i in 1:dim(OTUs)[1]){
  OTUsREL[i,]<- OTUs[i,]/sum(OTUs[i,])
}

# Log Transform Relative Abundances
OTUsREL.log <- decostand(OTUs, method="log")
```

## 6) Determine richness and and diversity

```{r}
# Observed Richness
S.obs <- rowSums((OTUs > 0) * 1)

# Simpson's Evenness
SimpE <- function(x = ""){
  x <- as.data.frame(x)
  D <- diversity(x, "inv")
  S <- sum((x > 0) * 1) 
  E <- (D)/S 
  return(E)
}
simpsE <- round(apply(OTUs, 1, SimpE), 3)

# Shannon's Diversity
H <- function(x = ""){
  x <- x[x>0]
  H = 0
  for (n_i in x){
    p = n_i / sum(x)
    H = H - p*log(p) 
  }
  return(H)
}

shan <- round(apply(OTUs, 1, H), 2)
shan2 <- diversity(OTUs, index = "shannon")

alpha.div <- cbind(design, S.obs, simpsE, shan)
```

## 7) PCoA of diversity within samples?

```{r}
shan<-shan[-2]
shan<-shan[-8]
shan<-shan[-8]
alpha.div <-alpha.div[1:7,]
plot(shan~Treatment, data=alpha.div, col=c('Grey','Orange'), ylab='Shannon Diversity Index')
anova(lm(shan~Treatment, data=alpha.div))
```

## 8) Rank Abundance Curve

```{r}
## Rank abundance curve ##
RAC <-function(x=""){
  x = as.vector(x)
  x.ab = x[x>0]
  x.ab.ranked=x.ab[order(x.ab, decreasing=TRUE)]
  return(x.ab.ranked)
}

rac <- RAC(x=OTUs[2, ])
ranks <- as.vector(seq(1, length(rac)))
opar <- par(no.readonly = TRUE)
par(mar=c(5.1, 5.1, 4.1, 2.1))
plot(ranks, log(rac), type='p', axes=F,
     xlab="Rank in Abundance", ylab="Abundance",
     las=1, cex.lab=1.4, cex.axis=1.25)
box()
axis(side=1, las=3, labels=T, cex.axis=1.25)
axis(side =2, las=1, cex.axis=1.25)
```

## 9) Racfit 

```{r}
RACresults <- radfit(rac)
RACresults
plot(RACresults, las=1, cex.lab=1.4, cex.axis=1.25)
```




