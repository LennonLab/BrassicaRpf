---
title: "Betadiversity"
author: "Venus"
date: "June 15, 2017"
output: html_document
---

## 1) Soil community Beta diversity 

Question: How does Rpf treatment affect soil bacterial composition? 

## 2) Set up work environment

```{r}
# Setup work enviroment 
rm(list = ls())
setwd("C:/Users/Venus/GitHub/BrassicaRpf/analysis")
source("C:/Users/Venus/GitHub/BrassicaRpf/analysis/MothurTools.R")

# Require or install packages #
package.list <- c('vegan', 'gplots' ,'BiodiversityR') 
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
  } }

# Load 
se <- function(x, ...){sd(x, na.rm = TRUE)/sqrt(length(na.omit(x)))}
```

## 3) Describe and load data set

Brassica.design.txt : 
Brassica.bac.final.shared: A sample by species matrix of bacterial OTUs from Illumina MiSeq sequencing run. 
Brassica.taxon : 

```{r}
# Define Inputs
# Design = general design file for experiment
# shared = OTU table from mothur with sequence similarity clustering
#design <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/output/Brassica.design.txt"
shared <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/output/Brassica.bac.final.shared"
#taxon <- "C:/Users/Venus/GitHub/BrassicaRpf/mothur/Brassica.bac.final.0.03.taxonomy"
```

## 4) Read otu using mothur tool code

Code functions used to read shared, text, taxonomy file was written by Mario Muscrella.
Outputs a OTU by sample table. 

```{r}
# Import Design
#design <- read.delim(design, header=T, row.names=1)

# Import Shared Files
OTUs <- read.otu(shared = shared, cutoff = "0.16")         # 86% Similarity

# Import Taxonomy
#OTU.tax <- read.tax(taxonomy = taxon, format = "rdp")

# Remove OTUs with less than two occurances across all sites
OTUs <- OTUs[, which(colSums(OTUs) >= 2)]

# Subset Brassica samples from OTU matrix #
OTUs <- OTUs[1:20, ]   # Remove University lake samples
```

## 5) Beta diversity Visualization of soil microbial communities

Resemblance Matrix 
Heatmap 
Cluster analysis 
PCoA ordination

```{r}
## Resemblance Matrix ##
Brassica.dj <- vegdist(OTUs, method="jaccard", binary=TRUE)
Brassica.db <-vegdist(OTUs, method="bray")
Brassica.db

## Heatmaps ##
# Custom Color #
jet.colors <- colorRampPalette(c("#00007F", "Blue", "#007FFF", "cyan",
                                 "#7FFF7F", "yellow", "#FF7F00", "red",
                                 "#7F0000"))
# Define Order of Sites #
order <- rev(attr(Brassica.db, "Labels"))

# Plot Heatmap
levelplot(as.matrix(Brassica.db)[, order], aspect = "iso", col.regions=jet.colors, 
          xlab = "OTUs", ylab = "Sample Sites", scales = list(cex=0.5),
          main = "Bray-Curtis Distance")

## Cluster Analysis ## 
Brassica.ward <- hclust(Brassica.db, method = "ward.D2")

par(mar=c(1,5,2,2) + 0.1)
plot(Brassica.ward, main="Brassica soil sample OTU clustering",
     ylab = "Squared Bray-Curtis Distance")
heatmap.2(as.matrix(OTUs), distfun = function(x) vegdist(x, method="bray"),
          hclustfun = function(x) hclust(x, method="ward.D2"), 
          col = jet.colors(100), trace="none", density.info = "none")
                                                    
## Ordination ## 
Brassica.pcoa <- cmdscale(Brassica.db, eig = TRUE, k=3)
Brassica.pcoa


explainvar1 <- round(Brassica.pcoa$eig[1]/sum(Brassica.pcoa$eig), 3)*100
explainvar2 <- round(Brassica.pcoa$eig[2]/sum(Brassica.pcoa$eig), 3)*100
explainvar3 <- round(Brassica.pcoa$eig[3]/sum(Brassica.pcoa$eig), 3)*100
sum.eig <- sum(explainvar1, explainvar2, explainvar3)
sum.eig

## Eigen Value PCoA Axis ##
par(mar=c(5,5,1,2)+0.1)
plot(Brassica.pcoa$eig, xlab="PCoA Axis", ylab="Eigenvalue",
     las=1, cex.lab=1.5, pch=16)
abline(h=mean(Brassica.pcoa$eig), lty=2, lwd=2, col="blue")
b.stick <-bstick(10, sum(Brassica.pcoa$eig))
lines(1:10, b.stick, type="l", lty=4, lwd=2, col="red")
legend("topright", legend=c("Ave Eigenvalue", "Broken-Stick"),
       lty=c(2,4), bty="n", col=c("blue", "red"))

## PCoA ##
par(mar=c(5,5,1,2)+0.1)
plot(Brassica.pcoa$points[ ,1], Brassica.pcoa$points[ ,2], ylim=c(-0.5, 0.5),
     xlab=paste("PCoA 1 (", explainvar1, "%)", sep=""),
     ylab=paste("PCoA 2 (", explainvar2, "%)", sep=""),
     pch=16, cex=2.0, type="n", cex.lab=1.5, cex.axis=1.2, axes=FALSE)
axis(side=1, labels=T, lwd.ticks=2, cex.axis=1.2, las=1)
axis(side=2, labels=T, lwd.ticks=2, cex.axis=1.2, las=1)
abline(h=0, v=0, lty=3)
box(lwd=2)

points(Brassica.pcoa$points[ ,1], Brassica.pcoa$points[ ,2],
       pch=19, cex=3, bg="gray", col="gray")
text(Brassica.pcoa$points[ ,1], Brassica.pcoa$points[ ,2],
     labels=row.names(Brassica.pcoa$points))

```

## 6) PERMANOVA analysis

```{r}
require("BiodiversityR")

# Relative Abundance #
Brassica.REL <- OTUs
  for(i in 1:nrow(OTUs)){
    Brassica.REL[i, ] = OTUs[i, ]
  }

Brassica.pcoa <- add.spec.scores(Brassica.pcoa, Brassica.REL, method="pcoa")
text(Brassica.pcoa$cproj[ ,1], Brassica.pcoa$cproj[ ,2],
     labels=row.names(Brassica.pcoa$cproj), col="black")

spe.corr <- add.spec.scores(Brassica.pcoa, Brassica.REL, method = "cor.scores")$cproj
corrcut <-0.7
imp.spp <- spe.corr[abs(spe.corr[ ,1]) >=corrcut | abs(spe.corr[ ,2])>= corrcut, ]

# Permuation test for species abundances across axes #
fit <- envfit(Brassica.pcoa, Brassica.REL, perm = 999)
fit

treatment <- c(rep("Rpf+",1), rep("Rpf-", 2), rep("DNA", 1), rep("cDNA", 3))
adonis(OTUs ~ treatment, method="bray", permutations=999)

```








