---
title: "RpfPlant"
author: "Venus Kuo"
date: "April 3, 2017"
output: html_document
---

## 1) Questions

- How does resuscitating the microbial seed bank affect plant fitness and producitivty?
- How does Rpf alter the soil microbial community actvity, abundance, and composition? 
- What is the role of the microbial seedbank in plant-soil microbe interactions?

## 2) Setting up work environment 

```{r, echo = FALSE}
# Set working directory #
rm(list = ls())
getwd()
setwd("C:/Users/Venus/Github/RpfPlants/data")

# Require or install packages #
package.list <- c('vegan', 'nlme' ,'data.table', 'plyr', 'reshape', 'reshape2', 'ggplot2') 
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
  } }
```

## 3) Description of data set

Plant Fitness.csv : Plant attributes collected at end of 6 week growing period. Information include ID number, Treatment (rpf+ = 1, rpf- = 2), soil type (complex = 2, simple = 1), flower.count, seed.count, SLA (Specific leaf area), height, abiomass (above ground biomass), bbiomass (below ground biomass), dweight (dry weight), wweight (wet weight), shoot.root (shoot:root ratio), total.biomass.

qPCR.csv : Quantitative PCR results of bacterial (EUB 338f-515r) and fungal (5.8f-ITs4r) gene copy abundances in live soil DNA taken from experimental pots containing Brassica plants. CSV file contains Treatment, Rep, Week, Well position, and Gene copy amount.

GCH_CO2.csv : CO2 respiration measurement of growth chamber soil samples for all six weeks. Contains sample ID, treatment (rpf+ = 1, rpf-= 2), soil (simple = 1, complex = 2), plant (present = 1, not present = 2), hour, week 1-6.

## 4) Load data set

```{r}
setwd("C:/Users/Venus/Github/RpfPlants/data")
# Read csv files # 
plantfitness <- read.csv("Plant Fitness.csv", header=T)
abundance <- read.csv("qPCR.csv", header=T) # Log transformed and standardized based on soil g# 
CO2 <- read.csv("GCH_CO2.csv", header=T)


# Define factor for plantfitness dataframe levels # 
plantfitness$Treatment <- factor(plantfitness$Treatment, levels=c(2,1), labels=c("Rpf-", "Rpf+"))
plantfitness$soil <- factor(plantfitness$soil, levels=c(2,1), labels=c("Live", "Sterilized"))
plantfitness <- plantfitness[-33, ]

# Define factor levels for bacterial and fungal qPCR data
abundance$Week<- factor(abundance$Week)
abundance <- na.omit(abundance)

# Define factor for CO2 respiration 
CO2$Treatment <- factor(CO2$Treatment, levels=c(2,1), labels=c("Rpf-", "Rpf+"))
CO2$soil <- factor(CO2$soil, levels=c(2,1), labels=c("Live", "Sterilized"))
CO2$hour <- factor(CO2$hour)
CO2$plant <- factor(CO2$plant, levels = c(2,1), labels=c("Not Present", "Present"))
```

## Hypothesis 1: If Rpf alters the soil microbial community by resuscitating dormant members of the microbial seed bank, then Rpf treatment will affect plant fitness and productivity. 

## Results: i.	Plant fitness (seeds and flowers) was not significantly affected by Rpf treatment. But plant productivity significantly decreased with Rpf treatment to soil in growth chamber experiment.

# Plant fitness # 

```{r}
# Plant Seeds produced as reproductive fitness metric # 
# Averaging the seed counts for each treatment and soil type group # 
seed.mean <- ddply(plantfitness, c("Treatment", "soil"), summarise, mean=mean(seed.count))

seed.mean.barplot<- ggplot(seed.mean, aes(x=soil,y = mean, fill=Treatment)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1.5)        
# Barplot of mean seed counts #

seed.mean.sem <- ddply(plantfitness, c("Treatment", "soil"), summarise, # Calculating standard error #
                   mean=mean(seed.count), sem=sd(seed.count)/sqrt(length(seed.count)))
seed.mean.sem <- transform(seed.mean.sem, lower=mean-sem, upper=mean+sem) 
# Plotting bar graph with standard error #
seed.mean.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=seed.mean.sem, width = 0.2, size = 1.5) +
  labs(x="Soil type", y="Number of seeds produced") +
  scale_fill_manual(values=c("Black", "White")) +
  theme_classic() +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  annotate("text", x =0.525, y=87.5, label = c("A"), size=12)
# Two-factored ANOVA of the effect of treatment and soil type on seed count # 
seed.aov <- anova(lm(seed.count ~ Treatment*soil, data=plantfitness))
seed.aov

# Flower count as potential fitness # 
flower.mean <- ddply(plantfitness, c("Treatment", "soil"), summarise,
               mean=mean(flower.count))

flower.mean.barplot<- ggplot(flower.mean, aes(x=soil,y = mean, fill=Treatment)) + 
   geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1.5) 

flower.mean.sem <- ddply(plantfitness, c("Treatment", "soil"), summarise,
                   mean=mean(flower.count), sem=sd(flower.count)/sqrt(length(flower.count)))
flower.mean.sem <- transform(flower.mean.sem, lower=mean-sem, upper=mean+sem)

flower.mean.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(.65), data=flower.mean.sem, width = 0.2, size=1.5) +
  labs(x="Soil type", y="Number of flowers produced") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  annotate("text", x =0.515, y=12.75, label = c("B"), size=12)


potentialfitness.aov <- anova(lm(flower.count ~ Treatment*soil, data=plantfitness))
potentialfitness.aov
# Plant reproductive output and fitness not affected by Rpf treatment or soil # 
```

# Plant biomass # 

```{r}
plantmeans <- ddply(plantfitness, c("Treatment", "soil"), summarise,
               mean=mean(total.biomass))

plantmeans.barplot<- ggplot(plantmeans, aes(x= soil ,y = mean, fill = Treatment)) + 
   geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1.5)

plantmeans.sem <- ddply(plantfitness, c("soil", "Treatment"), summarise,
                   mean=mean(total.biomass), sem=sd(total.biomass)/sqrt(length(total.biomass)))
plantmeans.sem <- transform(plantmeans.sem, lower=mean-sem, upper=mean+sem)

plantmeans.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=plantmeans.sem, width = 0.2, size=1.5) +
  labs(x="Soil type", y="Total plant biomass (g)") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  annotate("text", x =0.55, y=2.1, label = c("A"), size=12)


plant.t.aov <- anova(lm(total.biomass ~ Treatment*soil, data=plantfitness))
plant.t.aov
# Results: Total plant productivity was significantly (p < 0.005) reduced under Rpf treatment to soil # 

# Pattern being driven by aboveground or belowground biomass? # 
# Subsetting live soil data # 
plant.sub <- subset(plantfitness, soil=="Live", select=(c(Treatment, abiomass, bbiomass)))
plant.m <- melt(plant.sub) # Melting the above and belowground biomass # 
# Summarizing means of plant biomass data # 
plant.m.means <- ddply(plant.m, c("Treatment", "variable"), summarise,
               mean=mean(value))
# Plotting stacked bar graph # 
live.biomass.stacked.bar <- ggplot(plant.m.means, aes(x = Treatment, y = mean, fill = variable)) + 
  geom_bar(width=0.5, colour="black", size=1.5, stat = "identity")

# Making nicer stacked bar graph # 
live.biomass.stacked.bar + 
  labs(x="Treatment", y="Plant biomass (g)") +
  theme_classic() +
  scale_fill_manual(values=c("White", "Black")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18))+
  annotate("text", x =0.55, y=1.9, label = c("B"), size=12)

```

# Specific leaf area and plant height #

```{r}
SLA.mean <- ddply(plantfitness, c("Treatment", "soil"), summarise,
               mean=mean(SLA))
SLA.mean.barplot<- ggplot(SLA.mean, aes(x=soil,y = mean, fill=Treatment)) +
     geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1.5)
SLA.mean.sem <- ddply(plantfitness, c("Treatment", "soil"), summarise,
                   mean=mean(SLA), sem=sd(SLA)/sqrt(length(SLA)))
SLA.mean.sem <- transform(SLA.mean.sem, lower=mean-sem, upper=mean+sem)

SLA.mean.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65),
                              data=SLA.mean.sem, width = 0.2, size=1.5) +
  labs(x="Soil Type", y="SLA") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18))

SLA.aov <- anova(lm(SLA ~ Treatment*soil, data=plantfitness))
SLA.aov

# Plant height # 
height.mean <- ddply(plantfitness, c("Treatment", "soil"), summarise,
               mean=mean(height))
height.mean.barplot<- ggplot(height.mean, aes(x=soil,y = mean, fill=Treatment)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1.5) 
height.mean.sem <- ddply(plantfitness, c("Treatment", "soil"), summarise,
                   mean=mean(height), sem=sd(height)/sqrt(length(height)))
height.mean.sem <- transform(height.mean.sem, lower=mean-sem, upper=mean+sem)

height.mean.barplot + geom_errorbar(aes(ymax=upper,
                                  ymin=lower),
                              position=position_dodge(0.65),
                              data=height.mean.sem, width = 0.2, size=1.5) +
  labs(x="Soil Type", y="Plant maximum height") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=22),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18))

height.aov <- anova(lm(height ~ Treatment*soil, data=plantfitness))
height.aov
# Results: No dfference between SLA and plant height with Rpf treatment # 
```


## 6) Hypothesis 2: If Rpf alters the soil microbial community by resuscitating dormant members of the microbial seed bank, then Rpf treated soil will alter microbial abundance, activity, and active community composition. 

## 6) Results 2: Rpf treatment to growth chamber soil decreased microbial abundance, while actvity appeared to decline with week. 

# qPCR gene copy abundances as a metric for bacterial (16s rRNA) and fungal (ITS) abundance # 

```{r}
# Subset bacterial 16S dataset # 
bac.abundance <- subset(abundance, Gene=="16S rRNA" , select=c(Treatment, Week, Std.Gene.Copy))
# Bacterial abundance: 16S rRNA gene copy abundance # 
bac.means <- ddply(bac.abundance, c("Treatment", "Week"), summarise,
               mean=mean(Std.Gene.Copy))
bac.means.barplot <- ggplot(bac.means, aes(x=Week,y = mean, fill=Treatment)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1) 
bac.means.sem <- ddply(bac.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(Std.Gene.Copy), sem=sd(Std.Gene.Copy)/sqrt(length(Std.Gene.Copy)))
bac.means.sem <- transform(bac.means.sem, lower=mean-sem, upper=mean+sem)

bac.means.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=bac.means.sem, width = 0.2, size=1.5) +
  labs(x="Week", y="Bacteria 16S rRNA gene copy abundances") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=14),
        axis.text.x=element_text(colour="black", size =14),
        axis.title=element_text(size=14),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) #+
  annotate("text", x =0.55, y=17500, label = c("A"), size=12)

bac.aov <- anova(lm(Std.Gene.Copy ~ Treatment*Week, data=bac.abundance))
bac.aov
# Results: Rpf application to potted soil significantly (p<0.005) reduces bacterial 16S rRNA gene copy numbers # 
# Gene copy number increases significantly over the 6 week growth chamber experiment # 

# Subset ITS gene copy data # 
ITS.abundance <- subset(abundance, Gene=="ITS" , select=c(Treatment, Week, Std.Gene.Copy))
# Fungal abundance: ITS gene copy abundance # 
ITS.means <- ddply(ITS.abundance, c("Treatment", "Week"), summarise,
               mean=mean(Std.Gene.Copy))

ITS.mean.barplot<- ggplot(ITS.means, aes(x=Week,y = mean, fill=Treatment)) +
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1) 

ITS.means.sem <- ddply(ITS.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(Std.Gene.Copy), sem=sd(Std.Gene.Copy)/sqrt(length(Std.Gene.Copy)))
ITS.means.sem <- transform(ITS.means.sem, lower=mean-sem, upper=mean+sem)

ITS.mean.barplot + geom_errorbar(aes(ymax=upper,
                                  ymin=lower),
                              position=position_dodge(0.65),
                              data=ITS.means.sem, width = 0.2, size=1.5) +
  labs(x="Week", y="Fungal ITS gene copy abundances") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=15),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  annotate("text", x =0.55, y=42000, label = c("B"), size=12)

ITS.aov <- anova(lm(Std.Gene.Copy ~ Treatment*Week, data=ITS.abundance))
ITS.aov
```

# Soil CO2 respiration # 

```{r}
source("summarySE.R")
# Subsetting columns # 
CO2.sub <- subset(CO2, plant=="Present" & hour =="24", select=c(Treatment, soil, Week.1, Week.2, Week.3, Week.4, Week.5, Week.6))
# Melt data # 
CO2.m <- melt(CO2.sub)
# Summarizing data # 
CO2.means <- summarySE(CO2.m, measurevar="value", groupvars=c("Treatment","variable"))
# Plot line graph of summarized data # 
resp.line <- ggplot(CO2.means, aes(x=variable, y=value, color=Treatment)) + 
    geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.1) +
    geom_line() +
    geom_point()
# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right
# Plot line graph # 
ggplot(CO2.means, aes(x=variable, y=value, colour=Treatment, group=Treatment)) + 
    geom_errorbar(aes(ymin=value-se, ymax=value+se), colour="black", width=.1, position=pd) +
    geom_line(position=pd, size=1) +
    geom_point(position=pd, size=3, shape=21, fill="white") + # 21 is filled circle
    xlab("Growth chamber experiment weeks") +
    ylab("Soil CO2 respiration (ppm)") +
    scale_colour_hue(name="Treatment",    # Legend label, use darker colors
                     #breaks=c("Rpf-", "Rpf+"),
                     labels=c("Rpf-", "Rpf+"),
                     l=40) +   # Use darker colors, lightness=40
    theme_bw() +
    theme(legend.justification=c(1,0),
          legend.position=c(0.95,0.75),               # Position legend in bottom right
          axis.text.y=element_text(colour="black", size=12),
          axis.text.x=element_text(colour="black", size =12),
          axis.title=element_text(size=15),
          axis.title.y = element_text(colour="black",  margin = margin(0,10,0,0)),
          axis.title.x = element_text(colour="black",margin=margin(10,0,0,0)),
          panel.border = element_rect(linetype = "solid", colour = "black", size=2, fill=NA))   

# Creating data frame for RM-ANOVA #
# Constructing time-vy-species matrix #
time.by.CO2 <- group_by(, year, plot_id, plot_type) %>% count(taxon) %>% spread(key = taxon, value) 
# Calculate observed richness from time.by.species matrix #
```

