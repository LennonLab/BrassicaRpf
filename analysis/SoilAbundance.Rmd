---
title: "SoilAbundanceActivity"
author: "Venus"
date: "June 16, 2017"
output: html_document
---
## 1) Questions

- How does Rpf alter the soil microbial community abundance and activity? 


## 2) Setting up work environment 

```{r, echo = FALSE}
# Set working directory #
rm(list = ls())
getwd()
setwd("C:/Users/Venus/Github/BrassicaRpf/data")

# Require or install packages #
package.list <- c('vegan', 'nlme' ,'data.table', 'plyr', 'reshape', 'reshape2', 'ggplot2') 
for (package in package.list) {
  if (!require(package, character.only=T, quietly=T)) { 
    install.packages(package)
    library(package, character.only=T)
  } }
```

## 3) Description of data set

qPCR.csv : Quantitative PCR results of bacterial (EUB 338f-515r) and fungal (5.8f-ITs4r) gene copy abundances in live soil DNA taken from experimental pots containing Brassica plants. CSV file contains Treatment, Rep, Week, Well position, and Gene copy amount.

GCH_CO2.csv : CO2 respiration measurement of growth chamber soil samples for all six weeks. Contains sample ID, treatment (rpf+ = 1, rpf-= 2), soil (simple = 1, complex = 2), plant (present = 1, not present = 2), hour, week 1-6.


## 4) Load data set

```{r}
# Set working directory # 
setwd("C:/Users/Venus/Github/BrassicaRpf/data")

# Read csv files # 
abundance <- read.csv("qPCR.csv", header=T) # Log transformed and standardized based on soil gram # 
CO2 <- read.csv("GCH_CO2.csv", header=T)

# Define factor levels for bacterial and fungal qPCR data
abundance$Week<- factor(abundance$Week)
abundance <- na.omit(abundance)

# Define factor for CO2 respiration 
CO2$Treatment <- factor(CO2$Treatment, levels=c(2,1), labels=c("Rpf-", "Rpf+"))
CO2$soil <- factor(CO2$soil, levels=c(2,1), labels=c("Live", "Sterilized"))
CO2$hour <- factor(CO2$hour)
CO2$plant <- factor(CO2$plant, levels = c(2,1), labels=c("Not Present", "Present"))
```

## 5) Visualization of microbial abundance in soil

qPCR gene copy abundances as a metric for bacterial (16s rRNA). 
Two-factor ANOVA testing the effect of Rpf treatment and week number (1 or 6) on bacterial soil abundance.
qPCR gene copy abundances as a metric for fungal (ITS) abundance 
Two-factor ANOVA testing the effect of Rpf treatment and week number (1 or 6) on fungal soil abundance.

```{r}
# Subset bacterial 16S dataset # 
bac.abundance <- subset(abundance, Gene=="16S rRNA" , select=c(Treatment, Week, Std.Gene.Copy))

# Bacterial abundance: 16S rRNA gene copy abundance # 
bac.means <- ddply(bac.abundance, c("Treatment", "Week"), summarise, mean=mean(Std.Gene.Copy))

# Barplot of bacterial gene abundance in soil # 
bac.means.barplot <- ggplot(bac.means, aes(x=Week,y = mean, fill=Treatment)) + 
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1)

# Calculate bacterial gene abundance standard errors of the means # 
bac.means.sem <- ddply(bac.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(Std.Gene.Copy), sem=sd(Std.Gene.Copy)/sqrt(length(Std.Gene.Copy)))
bac.means.sem <- transform(bac.means.sem, lower=mean-sem, upper=mean+sem)

# Barplot of bacterial gene abundance in soil for pub figures # 
bac.means.barplot + geom_errorbar(aes(ymax=upper, ymin=lower),
                              position=position_dodge(0.65), data=bac.means.sem, width = 0.2, size=1.5) +
  labs(x="Week", y="Bacteria 16S rRNA gene copy abundances") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=14),
        axis.text.x=element_text(colour="black", size =14),
        axis.title=element_text(size=14),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) #+
  annotate("text", x =0.55, y=17500, label = c("A"), size=12)

# Two Factor ANOVA of 16S rRNA bacterial gene copy abundances affected by Treatment and week of growth chamber experiment # 
bac.aov <- anova(lm(Std.Gene.Copy ~ Treatment*Week, data=bac.abundance))
bac.aov
# Results: Rpf application to potted soil significantly (p<0.005) reduces bacterial 16S rRNA gene copy numbers # 
# Gene copy number increases significantly over the 6 week growth chamber experiment # 

#####

# Subset ITS gene copy data # 
ITS.abundance <- subset(abundance, Gene=="ITS" , select=c(Treatment, Week, Std.Gene.Copy))

# Fungal abundance: ITS gene copy abundance # 
ITS.means <- ddply(ITS.abundance, c("Treatment", "Week"), summarise, mean=mean(Std.Gene.Copy))

# Barplot of Fungal ITS abundance in soil # 
ITS.mean.barplot<- ggplot(ITS.means, aes(x=Week,y = mean, fill=Treatment)) +
  geom_bar(width=0.5, colour="black", position = position_dodge(width = 0.65), stat = "identity", size=1) 

# Calculate fungal ITS gene abundance standard errors of the means # 
ITS.means.sem <- ddply(ITS.abundance, c("Treatment", "Week"), summarise,
                   mean=mean(Std.Gene.Copy), sem=sd(Std.Gene.Copy)/sqrt(length(Std.Gene.Copy)))

ITS.means.sem <- transform(ITS.means.sem, lower=mean-sem, upper=mean+sem)

# Barplot of fungal gene abundance in soil for pub figures # 
ITS.mean.barplot + geom_errorbar(aes(ymax=upper,
                                  ymin=lower),
                              position=position_dodge(0.65),
                              data=ITS.means.sem, width = 0.2, size=1.5) +
  labs(x="Week", y="Fungal ITS gene copy abundances") +
  theme_classic() +
  scale_fill_manual(values=c("Black", "White")) +
  theme(axis.text.y=element_text(colour="black", size=18),
        axis.text.x=element_text(colour="black", size =18),
        axis.title=element_text(size=15),
        axis.title.y = element_text(colour="black",  margin = margin(0,10,0,10)),
        axis.title.x = element_text(colour="black",margin=margin(5,0,0,0)),
        panel.border = element_rect(linetype = "solid", colour = "black", size=3, fill=NA),
        axis.ticks.length = unit(.25, "cm"),
        axis.ticks = element_line(size = 2),
        legend.title = element_text(size=18),
        legend.text=element_text(size=18)) +
  annotate("text", x =0.55, y=42000, label = c("B"), size=12)

# Two Factor ANOVA of ITS Fungal gene copy abundances affected by Treatment and week of growth chamber experiment # 
ITS.aov <- anova(lm(Std.Gene.Copy ~ Treatment*Week, data=ITS.abundance))
ITS.aov
# Results: Rpf application to potted soil significantly (p<0.005) reduces bacterial 16S rRNA gene copy numbers # 
# Gene copy number increases significantly over the 6 week growth chamber experiment # 
```

## 6) Visualization of microbial activity in soil 

24 and 48 hour soil CO2 respiration taken each week over the course of growth chamber experiment. 


```{r}
# Load gplot source code # 
source("summarySE.R")

# Subsetting relevant data from CO2 dataset # 
CO2.sub <- subset(CO2, plant=="Present" & hour =="24", select=c(Treatment, soil, Week.1, Week.2, Week.3, Week.4, Week.5, Week.6))

# Melt data into three columns of treatment, soil and weeks # 
CO2.m <- melt(CO2.sub)

# Summarizing data # 
CO2.means <- summarySE(CO2.m, measurevar="value", groupvars=c("Treatment","variable"))

# Plot line graph of summarized data # 
resp.line <- ggplot(CO2.means, aes(x=variable, y=value, color=Treatment)) + 
    geom_errorbar(aes(ymin=value-se, ymax=value+se), width=.1) +
    geom_line() +
    geom_point()

# The errorbars overlapped, so use position_dodge to move them horizontally
pd <- position_dodge(0.1) # move them .05 to the left and right

# Plot line graph # 
ggplot(CO2.means, aes(x=variable, y=value, colour=Treatment, group=Treatment)) + 
    geom_errorbar(aes(ymin=value-se, ymax=value+se), colour="black", width=.1, position=pd) +
    geom_line(position=pd, size=1) +
    geom_point(position=pd, size=3, shape=21, fill="white") + # 21 is filled circle
    xlab("Growth chamber experiment weeks") +
    ylab("Soil CO2 respiration (ppm)") +
    scale_colour_hue(name="Treatment",    # Legend label, use darker colors
                     #breaks=c("Rpf-", "Rpf+"),
                     labels=c("Rpf-", "Rpf+"),
                     l=40) +   # Use darker colors, lightness=40
    theme_bw() +
    theme(legend.justification=c(1,0),
          legend.position=c(0.95,0.75),               # Position legend in bottom right
          axis.text.y=element_text(colour="black", size=12),
          axis.text.x=element_text(colour="black", size =12),
          axis.title=element_text(size=15),
          axis.title.y = element_text(colour="black",  margin = margin(0,10,0,0)),
          axis.title.x = element_text(colour="black",margin=margin(10,0,0,0)),
          panel.border = element_rect(linetype = "solid", colour = "black", size=2, fill=NA))   

# Creating data frame for RM-ANOVA #
# Constructing time-vy-species matrix #
time.by.CO2 <- group_by(, year, plot_id, plot_type) %>% count(taxon) %>% spread(key = taxon, value) 
# Calculate observed richness from time.by.species matrix #
```












